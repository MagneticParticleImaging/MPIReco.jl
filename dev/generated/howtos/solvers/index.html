<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Change and Configure Solvers · MPIReco</title><meta name="title" content="Change and Configure Solvers · MPIReco"/><meta property="og:title" content="Change and Configure Solvers · MPIReco"/><meta property="twitter:title" content="Change and Configure Solvers · MPIReco"/><meta name="description" content="Documentation for MPIReco."/><meta property="og:description" content="Documentation for MPIReco."/><meta property="twitter:description" content="Documentation for MPIReco."/><meta property="og:url" content="https://github.com/MagneticParticleImaging/MPIReco.jl/generated/howtos/solvers/"/><meta property="twitter:url" content="https://github.com/MagneticParticleImaging/MPIReco.jl/generated/howtos/solvers/"/><link rel="canonical" href="https://github.com/MagneticParticleImaging/MPIReco.jl/generated/howtos/solvers/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.png" alt="MPIReco logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">MPIReco</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../tutorials/overview/">Getting Started</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/basicReconstruction/">Basic Reconstructions</a></li><li><a class="tocitem" href="../../tutorials/weighting/">Weighting</a></li><li><a class="tocitem" href="../../tutorials/multiContrast/">Multi-Contrast</a></li><li><a class="tocitem" href="../../tutorials/matrixCompression/">Compression</a></li><li><a class="tocitem" href="../../tutorials/multiPatch/">Multi-Patch</a></li><li><a class="tocitem" href="../../tutorials/lowlevel/">Low-Level</a></li><li><a class="tocitem" href="../../tutorials/gpuAcceleration/">GPU-Acceleration</a></li><li><a class="tocitem" href="../../tutorials/distributed/">Distributed Reconstruction</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">How to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Change and Configure Solvers</a><ul class="internal"><li><a class="tocitem" href="#Solver-and-Solver-Parameters"><span>Solver and Solver Parameters</span></a></li><li><a class="tocitem" href="#Regularization-Term"><span>Regularization Term</span></a></li></ul></li><li><a class="tocitem" href="../caching/">Enable Caching</a></li><li><a class="tocitem" href="../custom/">Implement Custom Data Processing</a></li><li><a class="tocitem" href="../extensions/">Implement Reconstruction Packages</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Explanations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../datastructures/">Data Structures</a></li><li><a class="tocitem" href="../../explanations/recoplans/">MPIRecoPlan</a></li><li><a class="tocitem" href="../../explanations/operators/">Imaging Operators</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../references/utility/">Utility</a></li><li><a class="tocitem" href="../../../references/parameters/">Parameters</a></li><li><a class="tocitem" href="../../../references/singlepatch/">Single-Patch</a></li><li><a class="tocitem" href="../../../references/multipatch/">Multi-Patch</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to</a></li><li class="is-active"><a href>Change and Configure Solvers</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Change and Configure Solvers</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/MagneticParticleImaging/MPIReco.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/MagneticParticleImaging/MPIReco.jl/blob/master/docs/src/literate/howtos/solvers.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Change-and-Configure-Solvers"><a class="docs-heading-anchor" href="#Change-and-Configure-Solvers">Change and Configure Solvers</a><a id="Change-and-Configure-Solvers-1"></a><a class="docs-heading-anchor-permalink" href="#Change-and-Configure-Solvers" title="Permalink"></a></h1><p>MPIReco uses <a href="https://github.com/JuliaImageRecon/RegularizedLeastSquares.jl">RegularizedLeastSquares.jl</a> as its optimization backend. As such it can use any of the solvers and regularization terms defined for and in RegularizedLeastSquares.</p><p>In general, RegularizedLeastSquares aims to solve problems of the form:</p><p class="math-container">\[\begin{equation}
  \underset{\mathbf{c}}{argmin} \frac{1}{2}\vert\vert \mathbf{S}\mathbf{c}-\mathbf{u} \vert\vert_2^2 + + \mathbf{R(x)}
\end{equation}\]</p><p>where <span>$\mathbf{S}$</span> is a system matrix operator and <span>$\mathbf{u}$</span> is the measurement vector. Both are provided by MPIReco and constructed based on the specific parameters and processing steps of a given reconstruction algorithm. The (optional) regularization term <span>$\mathbf{R(x)}$</span> can be used to encode additional prior information about the inverse problem. Different solvers of RegularizedLeastSquares can work with different regularization terms. For example, the Kaczmarz and CGNR solver are defined for the <span>$l^2_2$</span>-norm. More information on available solvers and regularization terms can be found RegularizedLeastSquares documentation.</p><h2 id="Solver-and-Solver-Parameters"><a class="docs-heading-anchor" href="#Solver-and-Solver-Parameters">Solver and Solver Parameters</a><a id="Solver-and-Solver-Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Solver-and-Solver-Parameters" title="Permalink"></a></h2><p>MPIReco offers different ways to configure the used solvers, similar to how it for example offers different weighting strategies. If we take a look at the default solver parameters from the single-patch reconstruction:</p><pre><code class="language-julia hljs">plan = MPIRecoPlan(&quot;SinglePatch&quot;)
solverParams = plan.parameter.reco.solverParams</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RecoPlan{ElaborateSolverParameters}
├─ solver
├─ iterations
├─ enforceReal
├─ enforcePositive
├─ normalizeReg
├─ randomized
├─ subMatrixFraction
├─ shuffleRows
└─ seed
</code></pre><p>We see that the default parameters are of type <code>ElaborateSolverParameters</code>. These are a special set of parameters, because they contain the union of all solver parameters defined in RegularizedLeastSquares. The current selection of parameters changes based on the selected solver:</p><pre><code class="language-julia hljs">solverParams.solver = Kaczmarz
solverParams</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RecoPlan{ElaborateSolverParameters}
├─ solver = Kaczmarz
├─ iterations
├─ enforceReal
├─ enforcePositive
├─ normalizeReg
├─ randomized
├─ subMatrixFraction
├─ shuffleRows
└─ seed
</code></pre><p>or:</p><pre><code class="language-julia hljs">solverParams.solver = FISTA
solverParams</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">RecoPlan{ElaborateSolverParameters}
├─ solver = FISTA
├─ iterations
├─ enforceReal
├─ enforcePositive
├─ normalizeReg
├─ rho
├─ theta
├─ relTol
└─ restart
</code></pre><p>With these parameters we can define both the solver and the solver parameters as defined in RegularizedLeastSquares.</p><p>It is also possible to add new solvers, such as variants of existing solver specialised for MPI. To do this, we have to implement a new solver variant for RegularizedLeastSquares. We can either implement a new solver or implement a new variant of a solver via its state:</p><pre><code class="language-julia hljs">using MPIReco.RegularizedLeastSquares
mutable struct OurSolver{OP, T} &lt;: RegularizedLeastSquares.AbstractLinearSolver
  S::OP
  c::Vector{T}
  u::Vector{T}
  notification::String
end
function OurSolver(S; notification = &quot;Test&quot;, kwargs...)
  u = zeros(eltype(S), size(S, 1))
  c = zeros(eltype(S), size(S, 2))
  return OurSolver(S, c, u, notification)
end
function RegularizedLeastSquares.init!(solver::OurSolver{OP, T}, u) where {OP, T}
  solver.u .= u
  solver.c .= zero(T)
end
function Base.iterate(solver::OurSolver)
  @info solver.notification
  solver.c .= solver.S \ solver.u
  return nothing
end
RegularizedLeastSquares.solversolution(solver::OurSolver) = solver.c</code></pre><p>Afterwards, we can just use the solver type as usual:</p><pre><code class="language-julia hljs">params = Dict{Symbol, Any}()
params[:SNRThresh] = 5
params[:frames] = 1:1
params[:minFreq] = 80e3
params[:recChannels] = 1:2
params[:spectralLeakageCorrection] = true
params[:sf] = bSF;

c = reconstruct(&quot;SinglePatch&quot;, b; params..., solver = OurSolver)
fig = heatmap(c[1, :, :, 1, 1].data.data)
hidedecorations!(fig.axis)
fig</code></pre><img src="9d038154.png" alt="Example block output"/><p>If our custom solver requires custom parameters, we could implement custom solver parameters in MPIReco:</p><pre><code class="language-julia hljs">Base.@kwdef struct OurSolverParameters &lt;: MPIReco.AbstractSolverParameters{OurSolver}
  notification::String
  enforceReal::Bool=true
  enforcePositive::Bool=true
end
reconstruct(&quot;SinglePatch&quot;, b; params..., solverParams = OurSolverParameters(notification = &quot;Custom&quot;));</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">[ Info: Loading SM
[ Info: Preparing SF
[ Info: Adapting SF
┌ Warning: The following arguments were passed but filtered out: reg. Please watch closely if this introduces unexpexted behaviour in your code.
└ @ RegularizedLeastSquares ~/.julia/packages/RegularizedLeastSquares/HOcqi/src/RegularizedLeastSquares.jl:273
[ Info: Custom</code></pre><p>More on custom parameters for MPIReco can be found in <a href="../custom/#Custom-Data-Processing-and-Algorithms">Custom Data Processing and Algorithms</a>.</p><h2 id="Regularization-Term"><a class="docs-heading-anchor" href="#Regularization-Term">Regularization Term</a><a id="Regularization-Term-1"></a><a class="docs-heading-anchor-permalink" href="#Regularization-Term" title="Permalink"></a></h2><p>RegularizedLeastSquares allows for the generartion of flexible regularization using a vector of (nested) regularization terms. By providing such a vector, we can configure the regularization term similar to the solver:</p><pre><code class="language-julia hljs">setAll!(plan, :reg, [L2Regularization(0.1)])</code></pre><p>Because MPI oftens constrain its solutions to positive, real numbers, MPIReco offers some shortcurts to enable/disable these constraints:</p><pre><code class="language-julia hljs">setAll!(plan, :enforceReal, true)</code></pre><p>Internally, these are just additional regularization terms added to the provided regularization terms. For more complex regularization examples, take a look at the RegularizedLeastSquares documentation.</p><p>To implement a custom regularization we have to implement a proximal mapping:</p><p class="math-container">\[\begin{equation}
  prox_g (\mathbf{x}) = \underset{\mathbf{u}}{argmin} \frac{1}{2}\vert\vert \mathbf{u}-\mathbf{x} \vert {\vert}^2 + g(\mathbf{x}).
\end{equation}\]</p><p>For many regularizers, the proximal map can be computed efficiently in a closed form.</p><p>In order to implement these proximal mappings, we have to defines the following type functions for our new proximal map:</p><pre><code class="language-julia hljs">abstract type AbstractRegularization
prox!(reg::AbstractRegularization, x)
norm(reg::AbstractRegularization, x)</code></pre><p>Here <code>prox!(reg, x)</code> is an in-place function which computes the proximal map on the input-vector <code>x</code>. The function <code>norm</code> computes the value of the corresponding term in the inverse problem. RegularizedLeastSquares.jl provides <code>AbstractParameterizedRegularization</code> and <code>AbstractProjectionRegularization</code> as core regularization types.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../tutorials/distributed/">« Distributed Reconstruction</a><a class="docs-footer-nextpage" href="../caching/">Enable Caching »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Friday 25 July 2025 12:42">Friday 25 July 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
